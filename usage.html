
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Usage &#8212; DynamORM 0.11.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Developing" href="developing.html" />
    <link rel="prev" title="DynamORM" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h1>
<p>Using DynamORM is straight forward.  Simply define your models with some specific meta data to represent the DynamoDB Table structure as well as the document schema.  You can then use class level methods to query for and get items, represented as instances of the class, as well as class level methods to interact with specific documents in the table.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Not all functionality is covered in this documentation yet.  See <a class="reference external" href="https://github.com/NerdWalletOSS/DynamORM/tree/master/tests">the tests</a> for all “supported” functionality (like: batch puts, unique puts, etc).</p>
</div>
<div class="section" id="setting-up-boto3">
<h2>Setting up Boto3<a class="headerlink" href="#setting-up-boto3" title="Permalink to this headline">¶</a></h2>
<p>Make sure you have <a class="reference external" href="https://boto3.readthedocs.io/en/latest/guide/quickstart.html#configuration">configured boto3</a> and can access DynamoDB from the Python console.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">)</span>
<span class="nb">list</span><span class="p">(</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>  <span class="c1"># --&gt; [&#39;table1&#39;, &#39;table2&#39;, &#39;etc...&#39;]</span>
</pre></div>
</div>
<div class="section" id="configuring-the-boto3-resource">
<h3>Configuring the Boto3 resource<a class="headerlink" href="#configuring-the-boto3-resource" title="Permalink to this headline">¶</a></h3>
<p>The above example is relying on the files <code class="docutils literal notranslate"><span class="pre">~/.aws/credentials</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">~/.aws/config</span></code> to provide access information and region selection.  You can provide explicit configuration for <a class="reference external" href="http://boto3.readthedocs.io/en/latest/reference/core/session.html">boto3 sessions</a> and <a class="reference external" href="http://boto3.readthedocs.io/en/latest/reference/services/dynamodb.html#service-resource">boto3 resources</a> as part of your <code class="docutils literal notranslate"><span class="pre">Table</span></code> definition.</p>
<p>For example, if you develop against a local dynamo service your models may look something like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">DynaModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Table</span><span class="p">:</span>
        <span class="n">session_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;region_name&#39;</span><span class="p">:</span> <span class="s1">&#39;us-east-2&#39;</span>
        <span class="p">}</span>
        <span class="n">resource_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;endpoint_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://localhost:33333&#39;</span>
        <span class="p">}</span>
</pre></div>
</div>
<p>You would obviously want the session and resource configuration to come from some sort of configuration provider that could provide the correct options depending on where your application is being run.</p>
</div>
<div class="section" id="using-dynamo-local">
<h3>Using Dynamo Local<a class="headerlink" href="#using-dynamo-local" title="Permalink to this headline">¶</a></h3>
<p>If you’re using <a class="reference external" href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.html">Dynamo Local</a> for development you can use the following config for the table resource:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">MyModel</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">get_resource</span><span class="p">(</span>
    <span class="n">aws_access_key_id</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
    <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
    <span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;us-west-2&quot;</span><span class="p">,</span>
    <span class="n">endpoint_url</span><span class="o">=</span><span class="s2">&quot;http://localhost:8000&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="defining-your-models-tables-schemas">
<h2>Defining your Models – Tables &amp; Schemas<a class="headerlink" href="#defining-your-models-tables-schemas" title="Permalink to this headline">¶</a></h2>
<p>Models represent tables in DynamoDB and define the characteristics of the Dynamo service as well as the Marshmallow
or Schematics schema that is used for validating and marshalling your data.</p>
<dl class="py class">
<dt>
<em class="property">class </em><code class="sig-prename descclassname">dynamorm.model.</code><code class="sig-name descname">DynaModel</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">partial</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">raw</span></em><span class="sig-paren">)</span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">DynaModel</span></code> is the base class all of your models will extend from.  This model definition encapsulates the
parameters used to create and manage the table as well as the schema for validating and marshalling data into object
attributes.  It will also hold any custom business logic you need for your objects.</p>
<p>Your class must define two inner classes that specify the Dynamo Table options and the Schema, respectively.</p>
<p>The Dynamo Table options are defined in a class named <code class="docutils literal notranslate"><span class="pre">Table</span></code>.  See the <a class="reference internal" href="api.html#module-dynamorm.table" title="dynamorm.table"><code class="xref py py-mod docutils literal notranslate"><span class="pre">dynamorm.table</span></code></a> module for
more information.</p>
<p>Any Local or Global Secondary Indexes you wish to create are defined as inner tables that extend from either the
<code class="xref py py-class docutils literal notranslate"><span class="pre">LocalIndex</span></code> or <code class="xref py py-class docutils literal notranslate"><span class="pre">GlobalIndex</span></code> classes.  See the <a class="reference internal" href="api.html#module-dynamorm.table" title="dynamorm.table"><code class="xref py py-mod docutils literal notranslate"><span class="pre">dynamorm.table</span></code></a> module for more information.</p>
<p>The document schema is defined in a class named <code class="docutils literal notranslate"><span class="pre">Schema</span></code>, which should be filled out exactly as you would fill
out any other Marshmallow <a class="reference external" href="https://marshmallow.readthedocs.io/en/latest/api_reference.html#marshmallow.Schema" title="(in marshmallow v3.8.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Schema</span></code></a> or Schematics <code class="xref py py-class docutils literal notranslate"><span class="pre">Model</span></code>.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Marshmallow example</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">dynamorm</span> <span class="kn">import</span> <span class="n">DynaModel</span><span class="p">,</span> <span class="n">GlobalIndex</span><span class="p">,</span> <span class="n">ProjectAll</span>

<span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">fields</span><span class="p">,</span> <span class="n">validate</span><span class="p">,</span> <span class="n">validates</span><span class="p">,</span> <span class="n">ValidationError</span>

<span class="k">class</span> <span class="nc">Thing</span><span class="p">(</span><span class="n">DynaModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Table</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;things&#39;</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>
        <span class="n">read</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">write</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">class</span> <span class="nc">ByColor</span><span class="p">(</span><span class="n">GlobalIndex</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;by-color&#39;</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;color&#39;</span>
        <span class="n">read</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">write</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">ProjectAll</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Schema</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="o">.</span><span class="n">OneOf</span><span class="p">((</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)))</span>
        <span class="n">compound</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nd">@validates</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">validate_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="c1"># this is a very silly example just to illustrate that you can fill out the</span>
            <span class="c1"># inner Schema class just like any other Marshmallow class</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;evan&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;No Evan&#39;s allowed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello.  </span><span class="si">{name}</span><span class="s2"> here.  My ID is </span><span class="si">{id}</span><span class="s2"> and I&#39;m colored </span><span class="si">{color}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span>
        <span class="p">))</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="table-data-model">
<h2>Table Data Model<a class="headerlink" href="#table-data-model" title="Permalink to this headline">¶</a></h2>
<p>The inner <code class="docutils literal notranslate"><span class="pre">Table</span></code> class on <code class="docutils literal notranslate"><span class="pre">DynaModel</span></code> definitions becomes an instance of our
<a class="reference internal" href="api.html#dynamorm.table.DynamoTable3" title="dynamorm.table.DynamoTable3"><code class="xref py py-class docutils literal notranslate"><span class="pre">dynamorm.table.DynamoTable3</span></code></a> class.</p>
<p>The attributes you define on your inner <code class="docutils literal notranslate"><span class="pre">Table</span></code> class map to underlying boto data structures.  This mapping is
expressed through the following data model:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 10%" />
<col style="width: 5%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Attribute</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>name</p></td>
<td><p>True</p></td>
<td><p>str</p></td>
<td><p>The name of the table, as stored in Dynamo.</p></td>
</tr>
<tr class="row-odd"><td><p>hash_key</p></td>
<td><p>True</p></td>
<td><p>str</p></td>
<td><p>The name of the field to use as the hash key.
It must exist in the schema.</p></td>
</tr>
<tr class="row-even"><td><p>range_key</p></td>
<td><p>False</p></td>
<td><p>str</p></td>
<td><p>The name of the field to use as the range_key, if one is used.
It must exist in the schema.</p></td>
</tr>
<tr class="row-odd"><td><p>read</p></td>
<td><p>True</p></td>
<td><p>int</p></td>
<td><p>The provisioned read throughput.</p></td>
</tr>
<tr class="row-even"><td><p>write</p></td>
<td><p>True</p></td>
<td><p>int</p></td>
<td><p>The provisioned write throughput.</p></td>
</tr>
<tr class="row-odd"><td><p>stream</p></td>
<td><p>False</p></td>
<td><p>str</p></td>
<td><p>The stream view type, either None or one of:
‘NEW_IMAGE’|’OLD_IMAGE’|’NEW_AND_OLD_IMAGES’|’KEYS_ONLY’</p></td>
</tr>
</tbody>
</table>
<div class="section" id="indexes">
<h3>Indexes<a class="headerlink" href="#indexes" title="Permalink to this headline">¶</a></h3>
<p>Like the <code class="docutils literal notranslate"><span class="pre">Table</span></code> definition, Indexes are also inner classes on <code class="docutils literal notranslate"><span class="pre">DynaModel</span></code> definitions, and they require the same
data model with one extra field.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 8%" />
<col style="width: 6%" />
<col style="width: 76%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Attribute</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>projection</p></td>
<td><p>True</p></td>
<td><p>object</p></td>
<td><p>An instance of of <code class="xref py py-class docutils literal notranslate"><span class="pre">dynamorm.model.ProjectAll</span></code>,
<code class="xref py py-class docutils literal notranslate"><span class="pre">dynamorm.model.ProjectKeys</span></code>, or <code class="xref py py-class docutils literal notranslate"><span class="pre">dynamorm.model.ProjectInclude</span></code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="creating-new-documents">
<span id="id1"></span><h2>Creating new documents<a class="headerlink" href="#creating-new-documents" title="Permalink to this headline">¶</a></h2>
<p>Using objects:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">thing</span> <span class="o">=</span> <span class="n">Thing</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;thing1&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Thing One&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">)</span>
<span class="n">thing</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">thing</span> <span class="o">=</span> <span class="n">Thing</span><span class="p">()</span>
<span class="n">thing</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="s2">&quot;thing1&quot;</span>
<span class="n">thing</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Thing One&quot;</span>
<span class="n">thing</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;purple&quot;</span>
<span class="n">thing</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>Using raw documents:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Thing</span><span class="o">.</span><span class="n">put</span><span class="p">({</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;thing1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Thing One&quot;</span><span class="p">,</span>
    <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;purple&quot;</span>
<span class="p">})</span>
</pre></div>
</div>
<p>In all cases, the attributes go through validation against the Schema.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">thing</span> <span class="o">=</span> <span class="n">Thing</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;thing1&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Thing One&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>

<span class="c1"># the call to save will result in a ValidationError because orange is an invalid choice.</span>
<span class="n">thing</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember, if you have a <code class="docutils literal notranslate"><span class="pre">String</span></code> field it will use <code class="docutils literal notranslate"><span class="pre">unicode</span></code> (py2) or <code class="docutils literal notranslate"><span class="pre">str</span></code> (py3) on any value assigned to it, which means that if you assign a <code class="docutils literal notranslate"><span class="pre">list</span></code>, <code class="docutils literal notranslate"><span class="pre">dict</span></code>, <code class="docutils literal notranslate"><span class="pre">int</span></code>, etc then the validation will succeed and what will be stored is the representative string value.</p>
</div>
</div>
<div class="section" id="fetching-existing-documents">
<h2>Fetching existing documents<a class="headerlink" href="#fetching-existing-documents" title="Permalink to this headline">¶</a></h2>
<div class="section" id="get-based-on-primary-key">
<h3>Get based on primary key<a class="headerlink" href="#get-based-on-primary-key" title="Permalink to this headline">¶</a></h3>
<p>To fetch an existing document based on its primary key you use the <code class="docutils literal notranslate"><span class="pre">.get</span></code> class method on your models:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">thing1</span> <span class="o">=</span> <span class="n">Thing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;thing1&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">thing1</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;purple&#39;</span>
</pre></div>
</div>
<p>To do a <a class="reference external" href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.ReadConsistency.html">Consistent Read</a> just pass <code class="docutils literal notranslate"><span class="pre">consistent=True</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">thing1</span> <span class="o">=</span> <span class="n">Thing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;thing1&quot;</span><span class="p">,</span> <span class="n">consistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">thing1</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;purple&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="querying">
<h3>Querying<a class="headerlink" href="#querying" title="Permalink to this headline">¶</a></h3>
<blockquote class="epigraph">
<div><p>A Query operation uses the primary key of a table or a secondary index to directly access items from that table or index.</p>
<p class="attribution">—<a class="reference external" href="https://boto3.readthedocs.io/en/latest/reference/services/dynamodb.html#DynamoDB.Table.query">Table query docs</a></p>
</div></blockquote>
<p>Like a <code class="docutils literal notranslate"><span class="pre">get</span></code> operation this takes arguments that map to the key names, but you can also specify a comparison operator for that key using the “double-under” syntax (<code class="docutils literal notranslate"><span class="pre">&lt;field&gt;__&lt;operator&gt;</span></code>).  For example to query a <code class="docutils literal notranslate"><span class="pre">Book</span></code> model for all entries with the <code class="docutils literal notranslate"><span class="pre">isbn</span></code> field that start with a specific value you would use the <code class="docutils literal notranslate"><span class="pre">begins_with</span></code> comparison operator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">isbn__begins_with</span><span class="o">=</span><span class="s2">&quot;12345&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can find the full list of supported comparison operators in the <a class="reference external" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/customizations/dynamodb.html#dynamodb-conditions">DynamoDB Condition docs</a>.</p>
</div>
<div class="section" id="scanning">
<h3>Scanning<a class="headerlink" href="#scanning" title="Permalink to this headline">¶</a></h3>
<blockquote class="epigraph">
<div><p>The Scan operation returns one or more items and item attributes <strong>by accessing every item</strong> in a table or a secondary index.</p>
<p class="attribution">—<a class="reference external" href="https://boto3.readthedocs.io/en/latest/reference/services/dynamodb.html#DynamoDB.Table.scan">Table scan docs</a></p>
</div></blockquote>
<p>Scanning works exactly the same as querying.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Scan based on attributes</span>
<span class="n">Book</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="s2">&quot;Mr. Bar&quot;</span><span class="p">)</span>
<span class="n">Book</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">author__ne</span><span class="o">=</span><span class="s2">&quot;Mr. Bar&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="read-iterator-object">
<span id="read-iterators"></span><h3>Read Iterator object<a class="headerlink" href="#read-iterator-object" title="Permalink to this headline">¶</a></h3>
<p>Calling <code class="docutils literal notranslate"><span class="pre">.query</span></code> or <code class="docutils literal notranslate"><span class="pre">.scan</span></code> will return a <code class="docutils literal notranslate"><span class="pre">ReadIterator</span></code> object that will not actually send the API call to DynamoDB until you try to access an item in the object by iterating (<code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">book</span> <span class="pre">in</span> <span class="pre">books:</span></code>, <code class="docutils literal notranslate"><span class="pre">list(books)</span></code>, etc…).</p>
<p>The iterator objects have a number of methods on them that can be used to influence their behavior.  All of the methods described here (except <code class="docutils literal notranslate"><span class="pre">.count()</span></code>) are “chained methods”, meaning that they return the iterator object such that you can chain them together.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">next_10_books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">the_hash_key</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">previous_last</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="returning-the-count-count">
<h4>Returning the Count (<code class="docutils literal notranslate"><span class="pre">.count()</span></code>)<a class="headerlink" href="#returning-the-count-count" title="Permalink to this headline">¶</a></h4>
<p>Unlike the rest of the methods in this section, <code class="docutils literal notranslate"><span class="pre">.count()</span></code> is the only one that does not return the iterator object. Instead it changes the <a class="reference external" href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_Query.html#DDB-Query-request-Select">SELECT</a> parameter to <code class="docutils literal notranslate"><span class="pre">COUNT</span></code> and immediately sends the request, returning the count.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">books_matching_hash_key</span> <span class="o">=</span> <span class="n">Books</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">the_hash_key</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="requesting-consistent-results-consistent">
<h4>Requesting consistent results (<code class="docutils literal notranslate"><span class="pre">.consistent()</span></code>)<a class="headerlink" href="#requesting-consistent-results-consistent" title="Permalink to this headline">¶</a></h4>
<p>Queries &amp; scans return eventually consistent results by default.  You can use <code class="docutils literal notranslate"><span class="pre">.consistent()</span></code> to return results that ensure all in-flight writes finished and no new writes were launched.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Books</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">the_hash_key</span><span class="p">)</span><span class="o">.</span><span class="n">consistent</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="changing-the-returned-attributes-specific-attributes">
<h4>Changing the returned attributes (<code class="docutils literal notranslate"><span class="pre">.specific_attributes()</span></code>)<a class="headerlink" href="#changing-the-returned-attributes-specific-attributes" title="Permalink to this headline">¶</a></h4>
<p>By default, query &amp; scan operations will return ALL attributes from the table or index.  If you’d like to change the attributes to only return subset of the attributes you can pass a list to <code class="docutils literal notranslate"><span class="pre">.specific_attributes([...])</span></code>.  Each attribute passed in should match the syntax from <a class="reference external" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.Attributes.html">Specifying Item Attributes</a> in the docs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Books</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">the_hash_key</span><span class="p">)</span><span class="o">.</span><span class="n">specific_attributes</span><span class="p">([</span><span class="s1">&#39;isbn&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher.name&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="paging-last-start-again">
<h4>Paging (<code class="docutils literal notranslate"><span class="pre">.last</span></code>, <code class="docutils literal notranslate"><span class="pre">.start()</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">.again()</span></code>)<a class="headerlink" href="#paging-last-start-again" title="Permalink to this headline">¶</a></h4>
<blockquote class="epigraph">
<div><p>A single Query operation will read up to the maximum number of items set (if using the Limit parameter) or a maximum of 1 MB of data and then apply any filtering to the results</p>
<p class="attribution">—<a class="reference external" href="https://boto3.readthedocs.io/en/latest/reference/services/dynamodb.html#DynamoDB.Table.query">Table query docs</a></p>
</div></blockquote>
<p>When you query a table with many items, or with a limit, the iterator object will set its <code class="docutils literal notranslate"><span class="pre">.last</span></code> attribute to the key of the last item it received.  You can pass that item into a subsequent query via the <code class="docutils literal notranslate"><span class="pre">start()</span></code> method, or if you have the existing iterator object simply call <code class="docutils literal notranslate"><span class="pre">.again()</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">books</span><span class="p">))</span>

<span class="k">if</span> <span class="n">books</span><span class="o">.</span><span class="n">last</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The last book seen was: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">books</span><span class="o">.</span><span class="n">last</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">books</span><span class="o">.</span><span class="n">again</span><span class="p">()))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">last</span> <span class="o">=</span> <span class="n">get_last_from_request</span><span class="p">()</span>
<span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="limiting-limit">
<h4>Limiting (<code class="docutils literal notranslate"><span class="pre">.limit()</span></code>)<a class="headerlink" href="#limiting-limit" title="Permalink to this headline">¶</a></h4>
<blockquote class="epigraph">
<div><p>The maximum number of items to evaluate (not necessarily the number of matching items). If DynamoDB processes the number of items up to the limit while processing the results, it stops the operation and returns the matching values up to that point.</p>
<p class="attribution">—<a class="reference external" href="https://boto3.readthedocs.io/en/latest/reference/services/dynamodb.html#DynamoDB.Table.query">Table query docs</a></p>
</div></blockquote>
<p>You can also use the <code class="docutils literal notranslate"><span class="pre">.limit()</span></code> method on the iterator object to apply a Limit to your query.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">books</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="section" id="reversing-reverse-queries-only">
<h4>Reversing (<code class="docutils literal notranslate"><span class="pre">.reverse()</span></code> - Queries Only)<a class="headerlink" href="#reversing-reverse-queries-only" title="Permalink to this headline">¶</a></h4>
<p>To have the indexed scanned in reverse for your query, use <code class="docutils literal notranslate"><span class="pre">.reverse()</span></code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Scanning does not support reversing.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">hash_key</span><span class="o">=</span><span class="n">the_hash_key</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="recursion-recursive">
<h4>Recursion (<code class="docutils literal notranslate"><span class="pre">.recursive()</span></code>)<a class="headerlink" href="#recursion-recursive" title="Permalink to this headline">¶</a></h4>
<p>If you wish to get ALL items from a query or scan without having to deal with paging your self, then you can use the <code class="docutils literal notranslate"><span class="pre">recursive()</span></code> method to have the iterator handle the paging for you.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span><span class="o">.</span><span class="n">recursive</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="q-objects">
<span id="id2"></span><h3><code class="docutils literal notranslate"><span class="pre">Q</span></code> objects<a class="headerlink" href="#q-objects" title="Permalink to this headline">¶</a></h3>
<dl class="py function">
<dt>
<code class="sig-prename descclassname">dynamorm.table.</code><code class="sig-name descname">Q</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">**</span><span class="n">mapping</span></em><span class="sig-paren">)</span></dt>
<dd><p>A Q object represents an AND’d together query using boto3’s Attr object, based on a set of keyword arguments that
support the full access to the operations (eq, ne, between, etc) as well as nested attributes.</p>
<p>It can be used input to both scan operations as well as update conditions.</p>
</dd></dl>

<p>See the <a class="reference internal" href="api.html#dynamorm.model.DynaModel.scan" title="dynamorm.model.DynaModel.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">dynamorm.model.DynaModel.scan()</span></code></a> docs for more examples.</p>
</div>
<div class="section" id="id3">
<h3>Indexes<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>By default the hash &amp; range keys of your table make up the “Primary Index”.  <a class="reference external" href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/SecondaryIndexes.html">Secondary Indexes</a> provide different ways to query &amp; scan your data.  They are defined on your Model alongside the main Table definition as inner classes inheriting from either the <code class="docutils literal notranslate"><span class="pre">GlobalIndex</span></code> or <code class="docutils literal notranslate"><span class="pre">LocalIndex</span></code> classes.</p>
<p>Here’s an excerpt from the model used in the readme:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">DynaModel</span><span class="p">):</span>
    <span class="c1"># Define our DynamoDB properties</span>
    <span class="k">class</span> <span class="nc">Table</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;prod-books&#39;</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;isbn&#39;</span>
        <span class="n">read</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="n">write</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">class</span> <span class="nc">ByAuthor</span><span class="p">(</span><span class="n">GlobalIndex</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;by-author&#39;</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;author&#39;</span>
        <span class="n">read</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="n">write</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">ProjectAll</span><span class="p">()</span>
</pre></div>
</div>
<p>With the index defined we can now call <code class="docutils literal notranslate"><span class="pre">Book.ByAuthor.query</span></code> or <code class="docutils literal notranslate"><span class="pre">Book.ByAuthor.scan</span></code> to query or scan the index. The query &amp; scan semantics on the Index are the same as on the main table.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Book</span><span class="o">.</span><span class="n">ByAuthor</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="s1">&#39;Some Author&#39;</span><span class="p">)</span>
<span class="n">Book</span><span class="o">.</span><span class="n">ByAuthor</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">author__ne</span><span class="o">=</span><span class="s1">&#39;Some Author&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Indexes uses “projection” to determine which attributes of your documents are available in the index.  The <code class="docutils literal notranslate"><span class="pre">ProjectAll</span></code> projection puts ALL attributes from your Table into the Index.  The <code class="docutils literal notranslate"><span class="pre">ProjectKeys</span></code> projection puts just the keys from the table (and also the keys from the index themselves) into the index.  The <code class="docutils literal notranslate"><span class="pre">ProjectInclude('attr1',</span> <span class="pre">'attr2')</span></code> projection allows you to specify which attributes you wish to project.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">ProjectKeys</span></code> or <code class="docutils literal notranslate"><span class="pre">ProjectInclude</span></code> projection will result in partially validated documents, since we won’t have all of the require attributes.</p>
<p>A common pattern is to define a “sparse index” with just the keys (<code class="docutils literal notranslate"><span class="pre">ProjectKeys</span></code>), load the keys of the documents you want from the index and then do a batch get to fetch them all from the main table.</p>
</div>
</div>
<div class="section" id="updating-documents">
<h2>Updating documents<a class="headerlink" href="#updating-documents" title="Permalink to this headline">¶</a></h2>
<p>There are a number of ways to send updates back to the Table from your Model classes and indexes.  The <a class="reference internal" href="#creating-new-documents"><span class="std std-ref">Creating new documents</span></a> section already showed you the <a class="reference internal" href="api.html#dynamorm.model.DynaModel.save" title="dynamorm.model.DynaModel.save"><code class="xref py py-func docutils literal notranslate"><span class="pre">dynamorm.model.DynaModel.save()</span></code></a> methods for creating new documents.  <code class="docutils literal notranslate"><span class="pre">save</span></code> can also be used to update existing documents:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Our book is no longer in print</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;1234567890&#39;</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">in_print</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">book</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>When you call <code class="docutils literal notranslate"><span class="pre">.save()</span></code> on an instance the WHOLE document is put back into the table as save simply invokes the <a class="reference internal" href="api.html#dynamorm.model.DynaModel.put" title="dynamorm.model.DynaModel.put"><code class="xref py py-func docutils literal notranslate"><span class="pre">dynamorm.model.DynaModel.put()</span></code></a> function.  This means that if you have large models it may cost you more in Write Capacity Units to put the whole document back.</p>
<p>You can also do a “partial save” by passing <code class="docutils literal notranslate"><span class="pre">partial=True</span></code> when calling save, in which case the <a class="reference internal" href="api.html#dynamorm.model.DynaModel.update" title="dynamorm.model.DynaModel.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">dynamorm.model.DynaModel.update()</span></code></a> function will be used to only send the attributes that have been modified since the document was loaded.  The following two code blocks will result in the same operations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Our book is no longer in print</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;1234567890&#39;</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">in_print</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">book</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">partial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Our book is no longer in print</span>
<span class="n">book</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">isbn</span><span class="o">=</span><span class="s1">&#39;1234567890&#39;</span><span class="p">)</span>
<span class="n">book</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">in_print</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Doing partial saves (<code class="docutils literal notranslate"><span class="pre">.save(partial=True)</span></code>) is a very convenient way to work with existing instances, but using the <a class="reference internal" href="api.html#dynamorm.model.DynaModel.update" title="dynamorm.model.DynaModel.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">dynamorm.model.DynaModel.update()</span></code></a> directly allows for you to also send <a class="reference external" href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.UpdateExpressions.html">Update Expressions</a> and <a class="reference external" href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.ConditionExpressions.html">Condition Expressions</a> with the update.  Combined with consistent reads, this allows you to do things like acquire locks that ensure race conditions cannot happen:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Lock</span><span class="p">(</span><span class="n">DynaModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Table</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;locks&#39;</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>
        <span class="n">read</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">write</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">class</span> <span class="nc">Schema</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="n">is_locked</span> <span class="o">=</span> <span class="n">Boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">consistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inst</span><span class="o">.</span><span class="n">is_locked</span><span class="p">:</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">is_locked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                <span class="n">updated</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">updated</span><span class="o">=</span><span class="n">inst</span><span class="o">.</span><span class="n">updated</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">inst</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">unlock</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">consistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">inst</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
            <span class="n">inst</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">is_locked</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">updated</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="n">conditions</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">updated</span><span class="o">=</span><span class="n">inst</span><span class="o">.</span><span class="n">updated</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">inst</span>

<span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="s1">&#39;my-lock&#39;</span><span class="p">,</span> <span class="s1">&#39;my-key&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">lock</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;my-key&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to lock!&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lock acquired!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Just like Scanning or Querying a table, you can use <a class="reference internal" href="#q-objects"><span class="std std-ref">Q objects</span></a> for your update expressions.</p>
</div>
<div class="section" id="relationships">
<h2>Relationships<a class="headerlink" href="#relationships" title="Permalink to this headline">¶</a></h2>
<p>Relationships leverage the native tables &amp; indexes in DynamoDB to allow more concise definition and access of related
objects in your Python code.</p>
<p>You define relationships along side your Schema and Indexes on your model, and must provide the query used to map the
related models together.  You can also supply a “back reference” query to have the other side of the relationship also
have a relationship back to the defining model.</p>
<p>DynamORM provides the following relationship types:</p>
<ul class="simple">
<li><p><a class="reference internal" href="api.html#dynamorm.relationships.OneToOne" title="dynamorm.relationships.OneToOne"><code class="xref py py-class docutils literal notranslate"><span class="pre">dynamorm.relationships.OneToOne</span></code></a> - Useful when you have a large number of attributes to store and you want
to break them up over multiple tables for performance in querying.</p></li>
<li><p><a class="reference internal" href="api.html#dynamorm.relationships.OneToMany" title="dynamorm.relationships.OneToMany"><code class="xref py py-class docutils literal notranslate"><span class="pre">dynamorm.relationships.OneToMany</span></code></a> / <a class="reference internal" href="api.html#dynamorm.relationships.ManyToOne" title="dynamorm.relationships.ManyToOne"><code class="xref py py-class docutils literal notranslate"><span class="pre">dynamorm.relationships.ManyToOne</span></code></a> - Useful when you have an
instance of one model that has a collection of related instances of another model.  You use <code class="docutils literal notranslate"><span class="pre">OneToMany</span></code> or
<code class="docutils literal notranslate"><span class="pre">ManyToOne</span></code> depending on which side of the relationship you are defining the attribute on.  You’ll to use both
interchangeably based on how your models are laid out since you need to pass a reference to the other model into the
relationship.</p></li>
</ul>
<p>Here’s an example of how you could model the <a class="reference external" href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/SampleData.CreateTables.html#SampleData.CreateTables2">Forum Application</a> from the DynamoDB Examples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Reply</span><span class="p">(</span><span class="n">DynaModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Table</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;replies&#39;</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;forum_thread&#39;</span>
        <span class="n">range_key</span> <span class="o">=</span> <span class="s1">&#39;created&#39;</span>
        <span class="n">read</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">write</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">class</span> <span class="nc">ByUser</span><span class="p">(</span><span class="n">GlobalIndex</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;replies-by-user&#39;</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;user_name&#39;</span>
        <span class="n">range_key</span> <span class="o">=</span> <span class="s1">&#39;message&#39;</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">ProjectKeys</span><span class="p">()</span>
        <span class="n">read</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">write</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">class</span> <span class="nc">Schema</span><span class="p">:</span>
        <span class="n">forum_thread</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">created</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">user_name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">DynaModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Table</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>
        <span class="n">read</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">write</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">class</span> <span class="nc">Schema</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">replies</span> <span class="o">=</span> <span class="n">OneToMany</span><span class="p">(</span>
        <span class="n">Reply</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="s1">&#39;ByUser&#39;</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">user_name</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
        <span class="n">back_query</span><span class="o">=</span><span class="k">lambda</span> <span class="n">reply</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">reply</span><span class="o">.</span><span class="n">user_name</span><span class="p">)</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">Thread</span><span class="p">(</span><span class="n">DynaModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Table</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;threads&#39;</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;forum_name&#39;</span>
        <span class="n">range_key</span> <span class="o">=</span> <span class="s1">&#39;subject&#39;</span>
        <span class="n">read</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">write</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">class</span> <span class="nc">ByUser</span><span class="p">(</span><span class="n">GlobalIndex</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;threads-by-user&#39;</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;user_name&#39;</span>
        <span class="n">range_key</span> <span class="o">=</span> <span class="s1">&#39;subject&#39;</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">ProjectKeys</span><span class="p">()</span>
        <span class="n">read</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">write</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">class</span> <span class="nc">Schema</span><span class="p">:</span>
        <span class="n">forum_name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">user_name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">ManyToOne</span><span class="p">(</span>
        <span class="n">User</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="k">lambda</span> <span class="n">thread</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">user_name</span><span class="p">),</span>
        <span class="n">back_index</span><span class="o">=</span><span class="s1">&#39;ByUser&#39;</span><span class="p">,</span>
        <span class="n">back_query</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">user_name</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">replies</span> <span class="o">=</span> <span class="n">OneToMany</span><span class="p">(</span>
        <span class="n">Reply</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="k">lambda</span> <span class="n">thread</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">forum_thread</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">forum_name</span><span class="p">,</span> <span class="n">thread</span><span class="o">.</span><span class="n">subject</span><span class="p">)),</span>
        <span class="n">back_query</span><span class="o">=</span><span class="k">lambda</span> <span class="n">reply</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">forum_name</span><span class="o">=</span><span class="n">reply</span><span class="o">.</span><span class="n">forum_thread</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">subject</span><span class="o">=</span><span class="n">reply</span><span class="o">.</span><span class="n">forum_thread</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="k">class</span> <span class="nc">Forum</span><span class="p">(</span><span class="n">DynaModel</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Table</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;forums&#39;</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>
        <span class="n">read</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">write</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">class</span> <span class="nc">Schema</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">threads</span> <span class="o">=</span> <span class="n">OneToMany</span><span class="p">(</span>
        <span class="n">Thread</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="k">lambda</span> <span class="n">forum</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">forum_name</span><span class="o">=</span><span class="n">forum</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
        <span class="n">back_query</span><span class="o">=</span><span class="k">lambda</span> <span class="n">thread</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">thread</span><span class="o">.</span><span class="n">forum_name</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">DynamORM</a></h1>



<p class="blurb">Python object & relation mapping library for Amazon's DynamoDB service.<br /></p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=NerdWalletOSS&repo=dynamorm&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/NerdWalletOSS/dynamorm">
    <img
        alt="https://secure.travis-ci.org/NerdWalletOSS/dynamorm.svg?branch=master"
        src="https://secure.travis-ci.org/NerdWalletOSS/dynamorm.svg?branch=master"
    />
</a>
</p>




    

<p>
<a class="badge" href="https://codecov.io/github/NerdWalletOSS/dynamorm">
    <img
    alt="https://codecov.io/github/NerdWalletOSS/dynamorm/coverage.svg?branch=master"
    src="https://codecov.io/github/NerdWalletOSS/dynamorm/coverage.svg?branch=master"
    />
</a>
</p>
<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-boto3">Setting up Boto3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#defining-your-models-tables-schemas">Defining your Models – Tables &amp; Schemas</a></li>
<li class="toctree-l2"><a class="reference internal" href="#table-data-model">Table Data Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-new-documents">Creating new documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fetching-existing-documents">Fetching existing documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#updating-documents">Updating documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="#relationships">Relationships</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="developing.html">Developing</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">DynamORM API</a></li>
<li class="toctree-l1"><a class="reference internal" href="motivation.html">Motivation for creating DynamORM</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">DynamORM</a></li>
      <li>Next: <a href="developing.html" title="next chapter">Developing</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy; 2020 <a href="http://nerdwallet.com">NerdWallet</a>.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/NerdWalletOSS/dynamorm" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>